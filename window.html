<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src self 'unsafe-inline' file:">
    <title>Window</title>
  </head>

  <body>
    <h1>Window</h1>
    <button onclick="onClickNewWindow()">New Window</button>
    <button onclick="onClickIncrement()">Increment</button>
    <span>Counter=<span id="counter">?</span></span>

    <script src="poc.js"></script>
    <script>
      log('hello!');

      const pocSend = (messageType, payload) => {
        window.postMessage({messageType, payload}, '*');
      }

      const pocListeners = {};
      const pocAddListener = (messageType, callback) => {
        pocListeners[messageType] = callback;
      }

      window.addEventListener("message", event => {
        if (event.source !== window) {
          return;
        }

        const messageType = event.data.messageType;
        const payload = event.data.payload;

        if (pocListeners[messageType] !== undefined) {
          pocListeners[messageType](payload);
        }
      });

      pocSend('log', 'starting window');
      pocSend('getCounter');

      const onClickNewWindow = () => {
        pocSend('log', 'sending poc/new-window');
        pocSend('newWindow');
      }

      const onClickIncrement = () => {
        pocSend('log', 'sending poc/increment');
        pocSend('increment');
      }

      pocAddListener('updateCounter', payload => {
        pocSend('log', `received poc/update-counter with ${payload}`);
        document.getElementById('counter').innerText = payload;
      });
    </script>
  </body>
</html>
